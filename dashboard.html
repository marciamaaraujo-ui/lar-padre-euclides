<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - ILPI</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="renderizarDashboard()">

<!-- NAVBAR -->
<div class="navbar">
    <div class="nav-container">
        <img src="assets/logo.png" class="nav-logo" alt="Logo ILPI">

        <div class="nav-links">
            <a href="index.html" class="nav-link">üè† Nova Avalia√ß√£o</a>
            <a href="dashboard.html" class="nav-link home-btn">üìä Dashboard</a>
            <a href="ficha-completa.html" class="nav-link">üìÇ Ficha Cl√≠nica</a>
            <a href="exames-laboratoriais.html" class="nav-link">üß™ Exames</a>
            <a href="comorbidades.html" class="nav-link">üè• Comorbidades</a>
            <a href="metodologia.html" class="nav-link">üìò Metodologia</a>
            <a href="relatorio-executivo.html" class="nav-link">üìë Relat√≥rio</a>
        </div>
    </div>
</div>

<div class="container">

<header style="display:flex; justify-content:space-between; align-items:center;">
<div>
<h1>Painel Epidemiol√≥gico Institucional</h1>
<p>Indicadores assistenciais ILPI</p>
</div>

<button class="btn-save" onclick="exportarParaCSV()">üìä Exportar CSV</button>
</header>

<!-- INDICADORES -->
<div class="grid" style="margin-top:30px;">

<div class="stat-card">
<label>Total Residentes</label>
<p id="statTotal">0</p>
</div>

<div class="stat-card">
<label>Alto Risco Cl√≠nico</label>
<p id="statAlto">0</p>
</div>

<div class="stat-card">
<label>Risco Moderado</label>
<p id="statModerado">0</p>
</div>

<div class="stat-card">
<label>M√©dia IMC</label>
<p id="statIMC">0</p>
</div>

</div>

<!-- GR√ÅFICOS -->
<section style="margin-top:40px;">
<h3>Distribui√ß√£o de Risco</h3>
<canvas id="graficoRisco"></canvas>
</section>

<section style="margin-top:40px;">
<h3>Distribui√ß√£o IMC</h3>
<canvas id="graficoIMC"></canvas>
</section>

<!-- HIST√ìRICO -->
<section style="margin-top:50px;">
<h3>Hist√≥rico das √öltimas Avalia√ß√µes</h3>

<table>
<thead>
<tr>
<th>Residente</th>
<th>Data</th>
<th>IMC</th>
<th>ICN</th>
<th>Classifica√ß√£o</th>
</tr>
</thead>

<tbody id="corpoTabela"></tbody>
</table>

</section>

</div>

<script src="app.js"></script>

<script>

let chartRisco = null;
let chartIMC = null;

function renderizarDashboard() {

    const banco = obterBanco();

    let total = 0;
    let alto = 0;
    let moderado = 0;
    let somaIMC = 0;
    let baixoPeso = 0;

    const corpo = document.getElementById("corpoTabela");
    corpo.innerHTML = "";

    const nomes = Object.keys(banco).sort();
    if (nomes.length === 0) return;

    nomes.forEach(nome => {

        if (!banco[nome].avaliacoes || banco[nome].avaliacoes.length === 0) return;

        total++;

        const ultima = banco[nome].avaliacoes.slice(-1)[0];

        const imc = parseFloat(ultima.imc) || 0;
        somaIMC += imc;

        if (imc < 22) baixoPeso++;

        if (ultima.classificacaoICN === "Alto Risco Cl√≠nico") alto++;
        else if (ultima.classificacaoICN === "Risco Moderado") moderado++;

        corpo.innerHTML += `
            <tr>
                <td><strong>${nome}</strong></td>
                <td>${ultima.data || "-"}</td>
                <td>${ultima.imc || "-"}</td>
                <td>${ultima.icn || "-"}</td>
                <td>${ultima.classificacaoICN || "-"}</td>
            </tr>`;
    });

    document.getElementById("statTotal").innerText = total;
    document.getElementById("statAlto").innerText = alto;
    document.getElementById("statModerado").innerText = moderado;
    document.getElementById("statIMC").innerText =
        total > 0 ? (somaIMC / total).toFixed(1) : 0;

    atualizarGraficos(alto, moderado, total, baixoPeso);
}

function atualizarGraficos(alto, moderado, total, baixoPeso) {

    if (chartRisco) chartRisco.destroy();
    if (chartIMC) chartIMC.destroy();

    chartRisco = new Chart(document.getElementById("graficoRisco"), {
        type: "doughnut",
        data: {
            labels: ["Alto Risco", "Risco Moderado", "Baixo Risco"],
            datasets: [{
                data: [alto, moderado, total - alto - moderado]
            }]
        }
    });

    chartIMC = new Chart(document.getElementById("graficoIMC"), {
        type: "bar",
        data: {
            labels: ["IMC < 22", "IMC ‚â• 22"],
            datasets: [{
                data: [baixoPeso, total - baixoPeso]
            }]
        }
    });
}

</script>

</body>
</html>
